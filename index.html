<!DOCTYPE html>
<html lang="en">
    <head>
        <link
            rel="stylesheet"
            href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css"
            type="text/css"
        />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta
            name="keywords"
            content="OpenLayers, Maps, Geogrpahy, Antipodes"
        />
        <meta name="author" content="Omar Alshaker" />
        <meta name="copyright" content="Â© Copyright 2019 - Omar Alshaker" />
        <meta name="robots" content="index, follow" />
        <meta name="location" content="Warsaw, Poland" />
        <meta
            property="og:image"
            content="https://alshakero.github.io/antipodes/share-thumb.jpg"
        />
        <meta
            property="og:url"
            content="https://alshakero.github.io/antipodes/"
        />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Find Your Antipode" />
        <meta property="og:site-name" content="Antipodes" />
        <meta
            name="description"
            content="see where you'd end up if you dig really deep"
        />
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:site" content="@alshakero" />
        <meta name="twitter:creator" content="@alshakero" />
        <meta name="twitter:title" content="Find Your Antipode" />
        <meta
            name="twitter:description"
            content="see where you'd end up if you dig really deep"
        />
        <meta
            name="twitter:image:src"
            content="https://alshakero.github.io/antipodes/share-thumb.jpgg"
        />
        <style>
            body {
                margin: 0px;
            }

            .map {
                height: 100vh;
                width: 100%;
                cursor: none;
            }

            #description {
                position: absolute;
                top: 10px;
                left: 10px;
                background-color: rgba(0, 0, 0, 0.5);
                color: #fff;
                padding: 5px;
                transform: skew(-10deg);
                font-family: 'Courier New', Courier, monospace;
                font-size: 0.6em;
                margin: 5px 10px;
            }

            #creds {
                position: absolute;
                bottom: 5px;
                left: 10px;
                color: #000;
                font-family: 'Courier New', Courier, monospace;
                font-size: 0.6em;
            }

            #countriesDiv {
                position: absolute;
                bottom: 15px;
                background-color: rgba(0, 0, 0, 0.5);
                color: #fff;
                padding: 4px;
                font-family: 'Courier New', Courier, monospace;
                font-size: 0.7em;
                margin: 10px;
            }

            #creds a {
                color: #000;
            }
        </style>
        <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
        <title>Interactive Antipodes</title>
    </head>
    <body>
        <div id="map" class="map"></div>
        <div id="creds">
            <a href="https://omaralshaker.com">Omar Alshaker</a> 2019
        </div>
        <div id="description">
            Find your antipode: see where you'd end up if you dig really deep
        </div>
        <div id="countriesDiv">
            <span id="fromCountry"></span> -> <span id="toCountry"></span>
        </div>
        <script type="text/javascript">
            function getMinZoom() {
                var width = document.querySelector('#map').clientWidth;
                return Math.ceil(Math.LOG2E * Math.log(width / 256));
            }

            function locationToAPIURL(loc) {
                return `https://nominatim.openstreetmap.org/reverse?format=xml&lat=${
                    loc[1]
                }&lon=${
                    loc[0]
                }&zoom=18&addressdetails=0&zoom=0&format=json&accept-language=en-gbm&namedetails=1`;
            }

            function getName(response) {
                if (response.error) {
                    return 'Probably some ocean';
                }
                const d = response.namedetails['name:en'] || response.display_name;
                if(typeof d === 'object') {
                    debugger
                }
                return d;
            }
            async function getCountries(loc1, loc2) {
                const inCountry = await fetch(locationToAPIURL(loc1)).then(r =>
                    r.json()
                );
                const outCountry = await fetch(locationToAPIURL(loc2)).then(r =>
                    r.json()
                );
                return [getName(inCountry), getName(outCountry)];
            }

            const viewport = document.getElementById('map');

            function flipCoords(lon, lat) {
                return [
                    lon < 0 ? (Math.abs(lon) - 180) * -1 : Math.abs(lon) - 180,
                    -lat
                ];
            }

            const source = new ol.source.Vector({
                wrapX: false
            });

            const layer = new ol.layer.Vector({
                source
            });

            const inFeature = new ol.Feature({
                type: 'icon',
                geometry: new ol.geom.Point([44, 33])
            });

            inFeature.setStyle(
                new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        src: 'pin-in.png'
                    })
                })
            );

            const outFeature = new ol.Feature({
                type: 'icon',
                geometry: new ol.geom.Point([44, 33])
            });

            outFeature.setStyle(
                new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 1],
                        src: 'pin-out.png'
                    })
                })
            );

            source.addFeature(inFeature);
            source.addFeature(outFeature);

            const map = new ol.Map({
                target: 'map',

                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.OSM({ wrapX: false })
                    }),
                    layer
                ],
                view: new ol.View({
                    minZoom: getMinZoom(),
                    center: [0, 0],
                    zoom: 3,
                    projection: 'EPSG:4326'
                })
            });
            let debouceRef;

            map.on(['pointermove', 'singleclick'], ev => {
                const c = ev.coordinate;

                inFeature.getGeometry().setCoordinates(c);

                const antipode = flipCoords(...c);
                const g = outFeature.getGeometry();
                outFeature.getGeometry().setCoordinates(antipode);

                clearTimeout(debouceRef);
                debouceRef = setTimeout(async () => {
                    const countries = await getCountries(c, antipode);
                    console.log(countries)
                    fromCountry.textContent = countries[0];
                    toCountry.textContent = countries[1];
                }, 50);
            });
        </script>
    </body>
</html>
